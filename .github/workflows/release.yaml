name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Semver only — excludes floating tags like v1, v2

permissions: {}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: '1.24'

      - name: Verify dependencies
        run: go mod verify

      - name: Run tests
        run: go test -race -count=1 ./...

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: 'v2.6.1'

      - name: Set GOVERSION
        run: echo "GOVERSION=$(go env GOVERSION)" >> "$GITHUB_ENV"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          GOVERSION: ${{ env.GOVERSION }}

      - name: Generate SBOM
        run: |
          go install github.com/CycloneDX/cyclonedx-gomod/cmd/cyclonedx-gomod@v1.9.0
          cyclonedx-gomod mod -json -output sbom.cdx.json

      - name: Upload SBOM to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "$GITHUB_REF_NAME" sbom.cdx.json --clobber

      # Attestation steps use continue-on-error so one failure doesn't
      # cascade and kill the rest. The final verification step checks
      # that at least the binary attestation succeeded.
      - name: Attest binary archives
        id: attest-binaries
        continue-on-error: true
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: dist/pipelock_*.tar.gz

      - name: Attest checksums
        continue-on-error: true
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: dist/checksums.txt

      - name: Attest SBOM
        continue-on-error: true
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-path: dist/pipelock_*.tar.gz
          sbom-path: sbom.cdx.json

      - name: Get container digest
        id: digest
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          go install github.com/google/go-containerregistry/cmd/crane@v0.20.7
          if ! DIGEST=$(crane digest "ghcr.io/luckypipewrench/pipelock:${TAG}" 2>/dev/null); then
            echo "::warning::Failed to resolve container digest for tag ${TAG}"
            echo "digest=" >> "$GITHUB_OUTPUT"
          else
            echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          fi

      - name: Attest container image
        if: steps.digest.outputs.digest != ''
        continue-on-error: true
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-name: ghcr.io/luckypipewrench/pipelock
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: true

      - name: Verify attestation
        if: steps.attest-binaries.outcome == 'failure'
        run: |
          echo "::error::Binary attestation failed — release provenance is incomplete"
          exit 1

      # Move the v1 floating tag so `uses: luckyPipewrench/pipelock@v1`
      # always resolves to the latest release. Safe because the trigger
      # is v*.*.* which won't re-fire on the v1 push.
      - name: Update v1 floating tag for GitHub Action
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -fa v1 "${TAG_NAME}" -m "Update v1 to ${TAG_NAME}"
          git push origin v1 --force
